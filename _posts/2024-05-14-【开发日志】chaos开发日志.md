---
comments: true
title: 【开发日志】chaos开发日志
Author: SaZiKK
categories:
  - OS
  - develop
date modify:  2024-05-25 04:56:12 +0800
date: 2024-05-14 16:29:17 +0800
tags:
  - os
  - competition
date create:  2024-05-14 16:29:17 +0800
---
这是2024系统能力大赛操作系统内核赛道作品chaos开发日志，本项目基于ArceOS开发。
### 2024.5.14
结束前置学习，克隆项目，配置工作区。

### 2024.5.20
基本了解ArceOS思想及架构，进行初步更改。

#### ArceOS基本架构思想
ArceOS最大的特点就是组件化开发，它把系统内核的功能拆分为了系统有关和系统无关，也就是不可移植和可移植的区别。不可移植的模块叫module，命名以ax开头；可移植的模块叫crate，与内核只通过接口交流。

#### ArceOS实现全流程syscall过程
要想明白应该如何在ArceOS的架构中实现一个syscall，最好的方式就是从用户出发，从用户的syscall请求开始回溯。

在ArceOS中，用户直接面对的是来自用户库`ulib`的接口，用户只需要直接调用其中接口即可，在调用的同时，用户也要对应的启用一定的`feature`，这也是ArceOS的特色之一，我们先按下不表。深入`ulib`，仔细参考接口的实现后，可以发现接口都是对于`arceos_api`中方法的封装，正如其名字所说的那样，`arceos_api`提供了一系列面向用户库的接口，如最基础的`ax_console_read_byte`等。这里可以看到ArceOS的代码规范非常好，所有mod和lib文件都是非常干净的接口引用，没有添加任何功能代码的实现。

再进入`arceos_api`，我们就可以看到这里的方法来自各个module，同时我们熟悉的`sys_*`函数也分布在这里。实现过syscall的朋友们都知道（迫真），到这里就是一个`原子syscall`（我自己瞎取的名），即所有内核功能在这里首次被打包成一个完整syscall，再进行层层封装。

了解了syscall的调用流程，想要实现一个syscall也就简单了，具体syscall过程中，特权级的切换，上下文的保存等我还没有深究，还要继续研究，但是中断实现上应该都大差不差。

需要注意的是syscall的具体实现方法。ArceOS为我们实现了一个奇妙的宏`syscall_body`，我们需要传入syscall_id等参数，对于参数的主要操作也就是syscall的主要部分都在里面完成，宏如其名了属于是。

### 2024.5.23

淦，ArceOS看不下去了，转投rCore

#### 修改测试逻辑和用例
修改`Makefile`，让chaos可以运行初赛测例，同时基本删除原有的应用，只保留`shell`和`initproc`，再自定义了一个应用用于一键执行所有应用。

基本思路就是把编译好的elf初赛测例也和rust应用的elf文件塞到一起然后一起加载，rCore原有的流程扩展性不强，因此花了不少时间改。

#### 新建dev分支开发syscall

新维护了一个dev分支，同时队友大改文件系统，分了一个feat分支出去。

感觉换成rCore之后前途一片光明（完犊紫）啊。

### 2024.5.24

#### 实现`SYS_times`
统计一下进程的内核和用户态clock时间，之前写过，没什么难度。大致可以参考rCore的习题`扩展内核，统计每个应用完成时间`。

#### 修改测例顺序
王老板在参考linux源码重构文件系统，暂时不处理文件系统相关syscall，把文件系统相关syscall放到了后面。

### 2024.5.25

#### （4:38 am）实现`SYS_wait4`
只需要修复rCore的`sys_waitpid`方法即可。

这里踩了不少雷。首先是需要搞清楚对于`SYS_wait4`的调用函数看似很多而且各不相同，实际上都是`SYS_wait4`通过封装派生出来的，因此安安稳稳实现就行。

其次是`WEXITSTATUS`宏的问题。`WEXITSTATUS`宏名义上会取`wstatus`的低8位，作为子进程的退出状态，但是阅读其源码会发现，所谓低8位指的是小端法下的低8位！鬼知道为什么这里会出现小端！！因此在赋值的时候我们需要把传进去的`exit_code`左移8位来保证其存储在小端上（这里就偷懒不交换两端而是直接左移了），这样才能正确解析出退出状态值，通过测例。参考往届的代码也没有在这里做特殊处理，暂时不知道他怎么过的测例，猜测是FAT32文件系统发力了，而我们尚未实现FAT32，王老板还在猛肝。

### Todos：
- [ ] 继续实现syscall
- [ ] 
